import asyncio
import nest_asyncio
from modules.motion import MotionDetector
from modules.temperature_check import TemperatureChecker
import modules.detect_move as detect_move
import modules.telegram_alarm as telegram_alarm

async def main():
    application = telegram_alarm.create_telegram_app()

    user_sessions = {}

    async def periodic_check(user_id, sensor_number):
        print(f"사용자 {user_id}에 대한 주기적 점검을 수행합니다.")

        car_stopped = False

        while True:
            print(f"[{user_id}] 차량 상태를 점검합니다.")
            
            if not car_stopped:
                await asyncio.sleep(20)  # 차량 정차 시뮬레이션 대기 시간
                
                car_stopped = await detect_move.monitor_motion_and_stop()
                print(f"[{user_id}] 차량이 정차 상태로 변경되었습니다. 알림 전송 중...")
                await telegram_alarm.handle_car_stop(application, sensor_number)
                
                print(f"[{user_id}] 3분 대기 중...")
                await asyncio.sleep(20)  # 대기 시간
                
            print(f"[{user_id}] 모션 및 온도 체크 중...")
            
            while True:
                print(f"[{user_id}] 온도를 감지 중...")
                # 고온 감지
                if await temp_checker.check_temperature():
                    while True:
                        print(f"[{user_id}] 모션 센서를 감지 중...")
                        # 모션 센서 감지(총 3번 감지 되면 true)
                        if motion_detector.detect_motion():
                            print(f"[{user_id}] 고온 및 모션 감지 발생. 알림 전송 중...")
                            await telegram_alarm.send_detection_alert(application, sensor_number)
                            break
                        
                        await asyncio.sleep(5)  # 다음 점검까지 

    async def handle_new_user(update: telegram_alarm.Update, context):
        user_id = update.effective_user.id
        print(f"사용자 {user_id} 등록 시도 중...")

        new_sensor_number = await telegram_alarm.start(update, context)
        
        if new_sensor_number:
            if user_id in user_sessions:
                print(f"사용자 {user_id}의 기존 세션이 있습니다. 새 세션을 추가합니다.")
            else:
                print(f"사용자 {user_id}의 새로운 세션을 생성합니다.")
                user_sessions[user_id] = {"sensor_number": new_sensor_number}

            asyncio.create_task(periodic_check(user_id, new_sensor_number))

    application.add_handler(telegram_alarm.CommandHandler("start", handle_new_user))
    await application.run_polling(allowed_updates=telegram_alarm.Update.ALL_TYPES)

if __name__ == '__main__':
    nest_asyncio.apply()
    asyncio.run(main())
